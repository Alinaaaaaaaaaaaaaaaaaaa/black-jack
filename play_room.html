
<?php
session_start();
require_once 'connection.php';
require_once 'function.php'; 
$new_server = new server(1);
$new_server->chek_log();

//load_free_room();
//getPlayers($link);

?>

<html>
<head>
	<title>Таблица результатов</title>
	<link rel="stylesheet" href="../css/bootstrap.css">
	<link rel="stylesheet" href="../css/bootstrap.min.css">
	<link rel="stylesheet" href="../css/mystyle.css">
</head>
<body>
<div class="container-fluid ">
	<div class="row shadow mb-5 p-3 bg-white rounded mycolor">
		<div class="col-8">
			<h1 class="text-center header1 color_for_header1">Первая игровая комната</h1>
		</div>
		<div class="col-4 color_for_header1">
			<h1><?php 
			echo $_SESSION["user_name"];
			?>
			<span style="font-size: 1.75rem;" class="text-right" id="score_right">
			<?php 
				echo "you total score: ";
				echo $_SESSION["user_score"];
			?>
			</span>
			</h1>
<!-- 		<form action="play_room.php" method="post">
				<input type="submit" name="exit" value="ok">
			</form> -->
		</div>
	</div>
	<div class="row">
		<div class="col-3"> 
			<div class="row">
				<div class="col-3"></div>
				<div class="col-6" class ="activroombooton">
					<button type="button" class="btn-lg style_botton_2_kyrsovaya" >
					<a href="play_room1.html">Игровая комната 1</a>
					</button>

					<button type="button" class="btn-lg style_botton_2_kyrsovaya">
					<a href="tabke_res.php">Результаты</a>
					</button>
				</div>
				<div class="col-3"></div>
			</div>
		</div>
		<div class="col-6 shadow-lg  bg-white rounded p-3 mb-tabke_res5 mycolor" id="rooms">
			<div class="row header_leaders_b mb-2 ">
				<div class="col-1 h-100">Игрок</div>
				<div class="col-1 h-100" >Очки:</div>
				
				<div class="col-1 h-100">Карта:</div>
			</div>
			<div class="row table_leader header1">
				<div class="col-12 table_color">
					<div class="row pb-3 row_users">
						<div class="col-1">Загрузка</div>
						<div class="col-1"></div>
						<div class="col-1"><figure><img src = "../img/2.png"></figure></div>
						<div class="col-1"><figure><img src = "../img/2.png"></figure></div>

					</div>
					<div class="row pb-3 row_users">
						<div class="col-1">Загрузка</div>
						<div class="col-1"></div>
						<div class="col-1"><figure><img src = "../img/2.png"></figure></div>
						<div class="col-1"><figure><img src = "../img/2.png"></figure></div>

					</div>
					<div class="row pb-3 row_users">
						<div class="col-1">Загрузка</div>
						<div class="col-1"></div>
						<div class="col-1"><figure><img src = "../img/2.png"></figure></div>
						<div class="col-1"><figure><img src = "../img/2.png"></figure></div>

					</div>
					<div class="row pb-3 row_users">
						<div class="col-1">Загрузка</div>
						<div class="col-1"></div>
						<div class="col-1"><figure><img src = "../img/r.jpg"  img></figure></div>
						<div class="col-1"><figure><img src = "../img/r.jpg"  img></figure></div>

					</div>
					<div class="row mt-3">
						<div class="col-12">
							<h3 class="text-center">Подключаемся к игре..</h3>
						</div>
					</div>
				</div>
				
			</div>
		</div>
		<div class="col-3"></div>
	</div>
	<div class="row">
		<div class="col-3"></div>
		<div class="col-6 ">
			<div class="row">
				<div class="col-3">			
					<button type="button" class="btn-lg style_botton_ACCEPT" onclick="try_pick(1);">ACCEPT</button></div>
				<div class="col-7">		
					<div class="progress">
  					<div class="progress-bar progress-bar-striped bg-danger progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 74%" id="progress"></div>
					</div>		
				</div>
				<div class="col-2">				
					<button type="button" class="btn-lg style_botton_PASS" onclick="try_pick(0);">PASS</button>
				</div>
			</div>
		</div>
		<div class="col-3"></div>
	</div>

</div>
<script type="text/javascript">
document.onload = join_room();
//document.onload = load_players();
document.onload = try_pick(2);
//document.onload = load_my_id();
function load_my_id(){
	var xmlhttp;
	var my_id;
	xmlhttp = new XMLHttpRequest();
	xmlhttp.open("POST","server.php",true);
	xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
	xmlhttp.send('load_my_id=1');
	xmlhttp.onreadystatechange = function(){
		if(xmlhttp.readyState == 4 && xmlhttp.status == 200){
			var response = xmlhttp.responseText;
			my_id = response;
			load_card(my_id);
			load_my_play_score(my_id);
		}
	}
}
function load_my_play_score(my_id){
	var xmlhttp;
	xmlhttp = new XMLHttpRequest();
	xmlhttp.open("POST","server.php",true);
	xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
	xmlhttp.send('load_my_play_score=' + encodeURIComponent(my_id));
	xmlhttp.onreadystatechange = function(){
		if(xmlhttp.readyState == 4 && xmlhttp.status == 200){
			var response = xmlhttp.responseText;
			//alert(response);
			response = JSON.parse(response);//response[0] -score// response[1] - место игровое
			if( response == 0){
				alert("Не надо взламывать наш сервер!!");
			}else{
				if(response[0] == undefined){
					return;
				}
				var p = document.getElementsByClassName("row_users")[response[1] - 1];
				p.childNodes[1].innerHTML = response[0];
			}
		}
	}
}

function load_card(my_id){
	var xmlhttp;
	xmlhttp = new XMLHttpRequest();
	xmlhttp.open("POST","server.php",true);
	xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
	xmlhttp.send('load_card=' + encodeURIComponent(my_id));
	xmlhttp.onreadystatechange = function(){
		if(xmlhttp.readyState == 4 && xmlhttp.status == 200){
			var response = xmlhttp.responseText;
			response = JSON.parse(response);
			var buf = "";
			var p = document.getElementsByClassName("row_users");
			for(var i = 0; i < response.length;i++){
				//buf += p[i].innerHTML;
				for(var j = 0; j < response[i].card_player.length; j+=2){
					//alert(response[i].card_player.slice(j,j+2));
					buf +=  '<div class="col-1"><figure><img src = "../img/' + response[i
					].card_player.slice(j,j+2) +'.png"img></figure></div>'
				}
				p[i].innerHTML += buf;
				buf = "";
			}
			var buf = "";
			var p = document.getElementsByClassName("row_users");

			var win_user = 0;
			if(response[0].score_player > 1){
				for(var i = 0; i < response.length;i++){
					if(win_user < response[i].score_player && response[i].score_player < 22){
						win_user  = response[i].score_player;
					}
				}
			}
			for(var i = 0; i < response.length;i++){
				if(response[i].score_player > 21){
					p[i].childNodes[1].style.color = "red";
				}
				if(response[i].score_player  ==win_user ){
					p[i].childNodes[1].style.color = "green";
				}
				p[i].childNodes[1].innerHTML = response[i].score_player;
			}
		}
	}
}
/*var tm = 110;
function my_timer(){
	var p = document.getElementById("progress");
	p.style.width = "100%";
	let timerId = setInterval(function f1(){
		tm -= 1;
		p.style.width = tm + "%";
		if(p.style.width == "1%"){
			clearTimeout(timerId);
			try_pick(0);
		}
	},65);
}*/
let timerId1 = setInterval(try_pick,4000,2);
function try_pick(On_pick){
	var roomd_id = 1;
	var xmlhttp;
	xmlhttp = new XMLHttpRequest();
	xmlhttp.open("POST","server.php",true);
	xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
	xmlhttp.send('try_p=' + encodeURIComponent(On_pick) + '&load_rooms=' + encodeURIComponent(roomd_id));
	xmlhttp.onreadystatechange = function(){
		if(xmlhttp.readyState == 4 && xmlhttp.status == 200){
			var response = xmlhttp.responseText;
			response = JSON.parse(response);
			if( response == 601){
				//my_timer();
				//alert(response);
				//document.onload = load_players();
			}
			if(response == 2){
				try_new();//добавить таймер, добавть вывод победы!!
				document.onload = load_players();
				document.getElementById("info_t").innerHTML = "Начало новой игры";
			}
			setTimeout(load_players,100);
			setTimeout(load_my_id,100);
		}
	}
}
function try_new(){
	var xmlhttp;
	xmlhttp = new XMLHttpRequest();
	xmlhttp.open("POST","server.php",true);
	xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
	xmlhttp.send('new_game=1');
}
function load_players(){
	var roomd_id = 1;
	var xmlhttp;
	xmlhttp = new XMLHttpRequest();
	xmlhttp.open("POST","server.php",true);
	xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
	xmlhttp.send('load_players=1&load_rooms=' + encodeURIComponent(roomd_id));
	xmlhttp.onreadystatechange = function(){
		if(xmlhttp.readyState == 4 && xmlhttp.status == 200){
			var response = xmlhttp.responseText;
			response = JSON.parse(response);
			var table = "";
			var head = '<div class="row header_leaders_b mb-2 "><div class="col-1 h-100">Игрок</div><div class="col-3 h-100">Очки:</div> <div class="col-2 h-100">Карта:</div>';	
			var row_users = '<div class="row table_leader header1"><div class="col-12 table_color" id = "ceneter_t">';
			for(i = 0 ;i < 4;i++){
				row_users += '<div class="row pb-3 row_users"><div class="col-1">'+ response[i].user_n +'</div><div class="col-1 ml-5">??</div></div>';
			}
			row_users += '</div></div>';
			info ='<div class="row mt-3"><div class="col-12"><h3 class="text-center" id="info_t">Сейчас такой то ход</h3></div></div>';
			document.getElementById("rooms").innerHTML = head;
			document.getElementById("rooms").innerHTML += row_users;
			document.getElementById("ceneter_t").innerHTML += info;
			info1();
		}
	}
}
function info1(){
	var xmlhttp;
	xmlhttp = new XMLHttpRequest();
	xmlhttp.open("POST","server.php",true);
	xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
	xmlhttp.send('load_title=1');
	xmlhttp.onreadystatechange = function(){
		if(xmlhttp.readyState == 4 && xmlhttp.status == 200){
			var response = xmlhttp.responseText;
			response = JSON.parse(response);
			if(response == 2){
			document.getElementById("info_t").innerHTML = "Начало новой игры ";
		}else{
			document.getElementById("info_t").innerHTML = "Сейчас ходит " + response;}
		}}
}
function exit(){
		var xmlhttp;
		xmlhttp = new XMLHttpRequest();
		xmlhttp.open("POST","play_room.php",true);
		xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
		xmlhttp.send('destroy=1');
		setTimeout(function r(){document.location.reload();}, 500);
}
function join_room(){
	var xmlhttp;
	xmlhttp = new XMLHttpRequest();
	xmlhttp.open("POST","server.php",true);
	xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
	xmlhttp.send('join_room=1');
}


</script>
</body>
</html>
